<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹­ì°¬ì¹´ë“œê²Œì„ - ê´€ë¦¬ì</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .header p {
            color: #666;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            color: #666;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #5a6268);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #218838);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ë¯¸ì…˜ ê´€ë¦¬ */
        .mission-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }

        .mission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .mission-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .mission-text {
            flex: 1;
            margin-right: 15px;
            font-size: 0.95rem;
        }

        .mission-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* ê²Œì„ë°© í˜„í™© */
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .room-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #667eea;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .room-code {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }

        .room-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-waiting {
            background: #ffc107;
            color: #856404;
        }

        .status-playing {
            background: #28a745;
            color: white;
        }

        .status-finished {
            background: #6c757d;
            color: white;
        }

        .room-players {
            margin-bottom: 10px;
        }

        .player-name {
            display: inline-block;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin: 2px;
        }

        .player-name.host {
            background: #ffd700;
            color: #333;
        }

        .player-name.ai {
            background: #6c757d;
            color: white;
        }

        .room-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
        }

        /* ê²Œì„ ì„¤ì • */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .setting-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .setting-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }

        /* ë¡œë”© ë° ë©”ì‹œì§€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .admin-container {
                padding: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .rooms-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸ‰ ì¹­ì°¬ì¹´ë“œê²Œì„ ê´€ë¦¬ì</h1>
            <p>ê²Œì„ í˜„í™©ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ì„¤ì •ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ íƒ­ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">ëŒ€ì‹œë³´ë“œ</button>
            <button class="nav-tab" onclick="showTab('missions')">ë¯¸ì…˜ ê´€ë¦¬</button>
            <button class="nav-tab" onclick="showTab('rooms')">ê²Œì„ë°© í˜„í™©</button>
            <button class="nav-tab" onclick="showTab('settings')">ê²Œì„ ì„¤ì •</button>
        </div>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="messageArea"></div>

        <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
        <div id="dashboard" class="tab-content active">
            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRooms">-</div>
                    <div class="stat-label">ì „ì²´ ê²Œì„ë°©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeRooms">-</div>
                    <div class="stat-label">ì§„í–‰ ì¤‘ì¸ ê²Œì„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalPlayers">-</div>
                    <div class="stat-label">ì´ í”Œë ˆì´ì–´</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalMissions">-</div>
                    <div class="stat-label">ë“±ë¡ëœ ë¯¸ì…˜</div>
                </div>
            </div>

            <!-- ìµœê·¼ í™œë™ -->
            <div class="card">
                <h2>ğŸ“Š ì‹¤ì‹œê°„ í˜„í™©</h2>
                <div id="realtimeStatus">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¯¸ì…˜ ê´€ë¦¬ íƒ­ -->
        <div id="missions" class="tab-content">
            <div class="card">
                <h2>ğŸ“ ìƒˆ ë¯¸ì…˜ ì¶”ê°€</h2>
                <div class="form-group">
                    <label class="form-label" for="missionText">ë¯¸ì…˜ ë‚´ìš©</label>
                    <textarea id="missionText" class="form-textarea" placeholder="ì˜ˆ: ë‚´ê°€ ì–´ë ¤ìš´ ìƒí™©ì—ì„œ ì¹¨ì°©í•˜ê²Œ ëŒ€ì²˜í–ˆë˜ ìˆœê°„ì€?"></textarea>
                </div>
                <button class="btn btn-primary" onclick="addMission()">ë¯¸ì…˜ ì¶”ê°€</button>
                <button class="btn btn-secondary" onclick="clearMissionForm()">ì´ˆê¸°í™”</button>
            </div>

            <div class="card">
                <h2>ğŸ“‹ ë¯¸ì…˜ ëª©ë¡</h2>
                <div id="missionsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>ë¯¸ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê²Œì„ë°© í˜„í™© íƒ­ -->
        <div id="rooms" class="tab-content">
            <div class="card">
                <h2>ğŸ® ê²Œì„ë°© í˜„í™©</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="refreshRooms()">ìƒˆë¡œê³ ì¹¨</button>
                    <button class="btn btn-danger" onclick="cleanupFinishedRooms()">ì™„ë£Œëœ ê²Œì„ë°© ì •ë¦¬</button>
                </div>
                <div id="roomsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>ê²Œì„ë°©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê²Œì„ ì„¤ì • íƒ­ -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h2>âš™ï¸ ê²Œì„ ì„¤ì •</h2>
                <div class="settings-grid">
                    <div class="setting-item">
                        <div class="setting-title">ìµœëŒ€ í”Œë ˆì´ì–´ ìˆ˜</div>
                        <div class="setting-description">í•œ ê²Œì„ë°©ë‹¹ ìµœëŒ€ ì°¸ê°€ ê°€ëŠ¥í•œ í”Œë ˆì´ì–´ ìˆ˜</div>
                        <input type="number" id="maxPlayers" class="form-input" value="6" min="4" max="10">
                        <button class="btn btn-primary btn-small" onclick="updateSetting('maxPlayers')">ì €ì¥</button>
                    </div>

                    <div class="setting-item">
                        <div class="setting-title">ìµœëŒ€ ë¼ìš´ë“œ ìˆ˜</div>
                        <div class="setting-description">ê²Œì„ë‹¹ ì§„í–‰í•  ìµœëŒ€ ë¼ìš´ë“œ ìˆ˜</div>
                        <input type="number" id="maxRounds" class="form-input" value="5" min="3" max="10">
                        <button class="btn btn-primary btn-small" onclick="updateSetting('maxRounds')">ì €ì¥</button>
                    </div>

                    <div class="setting-item">
                        <div class="setting-title">AI ë´‡ ìë™ ì¶”ê°€</div>
                        <div class="setting-description">ì¸ì› ë¶€ì¡± ì‹œ AI ë´‡ ìë™ ì¶”ê°€ ì—¬ë¶€</div>
                        <select id="autoAI" class="form-input">
                            <option value="true">í™œì„±í™”</option>
                            <option value="false">ë¹„í™œì„±í™”</option>
                        </select>
                        <button class="btn btn-primary btn-small" onclick="updateSetting('autoAI')">ì €ì¥</button>
                    </div>

                    <div class="setting-item">
                        <div class="setting-title">ì¹´ë“œ ì¢…ë¥˜ë³„ ê°œìˆ˜</div>
                        <div class="setting-description">ê° ì¹´ë“œ ì¢…ë¥˜ë³„ 1~5ë²ˆ ì¹´ë“œ ê°œìˆ˜</div>
                        <input type="number" id="cardsPerType" class="form-input" value="5" min="3" max="7">
                        <button class="btn btn-primary btn-small" onclick="updateSetting('cardsPerType')">ì €ì¥</button>
                    </div>
                </div>
            </div>

                <div class="card">
                    <h2>ğŸ—ƒï¸ ë°ì´í„° ê´€ë¦¬</h2>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="exportGameData()">ê²Œì„ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                        <button class="btn btn-danger" onclick="clearOldData()">ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬</button>
                        <button class="btn btn-success" onclick="backupData()">ë°ì´í„° ë°±ì—…</button>
                        <button class="btn btn-danger" onclick="resetAllGames()" style="background: linear-gradient(45deg, #ff4757, #ff3838);">ğŸš¨ ëª¨ë“  ê²Œì„ ë¦¬ì…‹</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyC3IwL7hYsWIT6wRpenGXwqvSBtV_WIx-M",
            authDomain: "complimentcardgame.firebaseapp.com",
            projectId: "complimentcardgame",
            storageBucket: "complimentcardgame.firebasestorage.app",
            messagingSenderId: "766205964734",
            appId: "1:766205964734:web:0aa711ffc46f96e51889ef",
            measurementId: "G-P7KM5ETH2J"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let gameRooms = [];
        let missions = [];
        let realtimeListener = null;

        // ê¸°ë³¸ ë¯¸ì…˜ ë°ì´í„°
        const defaultMissions = [
            "ë‚´ê°€ ì–´ë ¤ìš´ ìƒí™©ì—ì„œ ì¹¨ì°©í•˜ê²Œ ëŒ€ì²˜í–ˆë˜ ìˆœê°„ì€?",
            "ë‚´ê°€ íŒ€ì›ë“¤ì—ê²Œ ë„ì›€ì´ ë˜ì—ˆë˜ ê²½í—˜ì€?",
            "ë‚´ê°€ ì°½ì˜ì ì¸ ì•„ì´ë””ì–´ë¥¼ ì œì‹œí–ˆë˜ ë•ŒëŠ”?",
            "ë‚´ê°€ ë¦¬ë”ì‹­ì„ ë°œíœ˜í–ˆë˜ ëª¨ìŠµì€?",
            "ë‚´ê°€ ê¼¼ê¼¼í•˜ê³  ì±…ì„ê° ìˆê²Œ ì¼í–ˆë˜ ê²½ìš°ëŠ”?",
            "ë‚´ê°€ ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ì „ë‹¬í–ˆë˜ ìˆœê°„ì€?",
            "ë‚´ê°€ ë¬¸ì œ í•´ê²° ëŠ¥ë ¥ì„ ë³´ì—¬ì¤€ ì‚¬ë¡€ëŠ”?",
            "ë‚´ê°€ ì†Œí†µì„ ì˜í–ˆë˜ ê²½í—˜ì€?",
            "ë‚´ê°€ ì„±ì¥í•˜ëŠ” ëª¨ìŠµì„ ë³´ì—¬ì¤€ ë•ŒëŠ”?",
            "ë‚´ê°€ ë°°ë ¤ì‹¬ì„ ë°œíœ˜í–ˆë˜ ìˆœê°„ì€?",
            "ë‚´ê°€ ë™ë£Œë“¤ì„ ê²©ë ¤í–ˆë˜ ê²½í—˜ì€?",
            "ë‚´ê°€ ìƒˆë¡œìš´ ê²ƒì„ í•™ìŠµí•˜ëŠ” ëª¨ìŠµì„ ë³´ì—¬ì¤€ ë•ŒëŠ”?",
            "ë‚´ê°€ ì±…ì„ê° ìˆê²Œ ì—…ë¬´ë¥¼ ë§ˆë¬´ë¦¬í•œ ê²½í—˜ì€?",
            "ë‚´ê°€ íŒ€ì›Œí¬ë¥¼ ë°œíœ˜í–ˆë˜ ìˆœê°„ì€?",
            "ë‚´ê°€ ìœ ë¨¸ë¡œ ë¶„ìœ„ê¸°ë¥¼ ì¢‹ê²Œ ë§Œë“  ê²½í—˜ì€?",
            "ë‚´ê°€ ë‹¤ë¥¸ ì‚¬ëŒì˜ ì˜ê²¬ì„ ì˜ ë“¤ì–´ì¤€ ë•ŒëŠ”?",
            "ë‚´ê°€ ìŠ¤íŠ¸ë ˆìŠ¤ ìƒí™©ì—ì„œë„ ê¸ì •ì ìœ¼ë¡œ ëŒ€ì²˜í•œ ê²½í—˜ì€?",
            "ë‚´ê°€ ìƒˆë¡œìš´ ë„ì „ì„ ë‘ë ¤ì›Œí•˜ì§€ ì•Šì•˜ë˜ ìˆœê°„ì€?",
            "ë‚´ê°€ ë‹¤ë¥¸ ì‚¬ëŒì„ ìœ„í•´ ì–‘ë³´í–ˆë˜ ê²½í—˜ì€?",
            "ë‚´ê°€ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•´ ëˆê¸°ìˆê²Œ ë…¸ë ¥í•œ ì‚¬ë¡€ëŠ”?"
        ];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // ìµëª… ë¡œê·¸ì¸
                await auth.signInAnonymously();
                currentUser = auth.currentUser;
                
                // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
                await initializeData();
                loadDashboard();
                loadMissions();
                loadRooms();
                
                // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                startRealtimeListener();
                
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showMessage('ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });

        // ë°ì´í„° ì´ˆê¸°í™”
        async function initializeData() {
            // ë¯¸ì…˜ ì»¬ë ‰ì…˜ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ ë¯¸ì…˜ ì¶”ê°€
            const missionsSnapshot = await db.collection('missions').limit(1).get();
            if (missionsSnapshot.empty) {
                const batch = db.batch();
                defaultMissions.forEach((mission, index) => {
                    const docRef = db.collection('missions').doc();
                    batch.set(docRef, {
                        text: mission,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        order: index + 1
                    });
                });
                await batch.commit();
                showMessage('ê¸°ë³¸ ë¯¸ì…˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // íƒ­ ì „í™˜
        function showTab(tabName) {
            // íƒ­ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // íƒ­ ì½˜í…ì¸  ì—…ë°ì´íŠ¸
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'missions':
                    loadMissions();
                    break;
                case 'rooms':
                    loadRooms();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        async function loadDashboard() {
            try {
                // ê²Œì„ë°© ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const roomsSnapshot = await db.collection('games').get();
                const rooms = roomsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ë¯¸ì…˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const missionsSnapshot = await db.collection('missions').get();
                
                // í†µê³„ ê³„ì‚°
                const totalRooms = rooms.length;
                const activeRooms = rooms.filter(room => room.status === 'playing').length;
                const totalPlayers = rooms.reduce((sum, room) => 
                    sum + (room.players ? room.players.filter(p => !p.isAI).length : 0), 0);
                const totalMissions = missionsSnapshot.size;
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('totalRooms').textContent = totalRooms;
                document.getElementById('activeRooms').textContent = activeRooms;
                document.getElementById('totalPlayers').textContent = totalPlayers;
                document.getElementById('totalMissions').textContent = totalMissions;
                
                // ì‹¤ì‹œê°„ í˜„í™© ì—…ë°ì´íŠ¸
                updateRealtimeStatus(rooms);
                
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
                showMessage('ëŒ€ì‹œë³´ë“œ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì‹¤ì‹œê°„ í˜„í™© ì—…ë°ì´íŠ¸
        function updateRealtimeStatus(rooms) {
            const statusEl = document.getElementById('realtimeStatus');
            
            if (rooms.length === 0) {
                statusEl.innerHTML = '<div class="message info">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê²Œì„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
            
            rooms.filter(room => room.status === 'playing').slice(0, 6).forEach(room => {
                const humanPlayers = room.players ? room.players.filter(p => !p.isAI) : [];
                const aiPlayers = room.players ? room.players.filter(p => p.isAI) : [];
                
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <div style="font-weight: bold; color: #28a745; margin-bottom: 8px;">ë°© ${room.roomCode}</div>
                        <div style="font-size: 0.9rem; color: #666;">
                            ğŸ‘¥ ${humanPlayers.length}ëª… + ğŸ¤– ${aiPlayers.length}ëª…<br>
                            ğŸ† ë¼ìš´ë“œ ${room.currentRound || 1}<br>
                            â° ${formatTime(room.startedAt)}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            statusEl.innerHTML = html;
        }

        // ë¯¸ì…˜ ê´€ë¦¬ ë¡œë“œ
        async function loadMissions() {
            try {
                const snapshot = await db.collection('missions').orderBy('order', 'asc').get();
                missions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                updateMissionsList();
                
            } catch (error) {
                console.error('ë¯¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                showMessage('ë¯¸ì…˜ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë¯¸ì…˜ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateMissionsList() {
            const listEl = document.getElementById('missionsList');
            
            if (missions.length === 0) {
                listEl.innerHTML = '<div class="message info">ë“±ë¡ëœ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '<div class="mission-list">';
            missions.forEach((mission, index) => {
                html += `
                    <div class="mission-item">
                        <div class="mission-text">${mission.text}</div>
                        <div class="mission-actions">
                            <button class="btn btn-secondary btn-small" onclick="editMission('${mission.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-small" onclick="deleteMission('${mission.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            listEl.innerHTML = html;
        }

        // ë¯¸ì…˜ ì¶”ê°€
        async function addMission() {
            const text = document.getElementById('missionText').value.trim();
            if (!text) {
                showMessage('ë¯¸ì…˜ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            try {
                await db.collection('missions').add({
                    text: text,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    order: missions.length + 1
                });
                
                showMessage('ë¯¸ì…˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                clearMissionForm();
                loadMissions();
                
            } catch (error) {
                console.error('ë¯¸ì…˜ ì¶”ê°€ ì˜¤ë¥˜:', error);
                showMessage('ë¯¸ì…˜ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë¯¸ì…˜ ì‚­ì œ
        async function deleteMission(missionId) {
            if (!confirm('ì •ë§ë¡œ ì´ ë¯¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await db.collection('missions').doc(missionId).delete();
                showMessage('ë¯¸ì…˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadMissions();
                
            } catch (error) {
                console.error('ë¯¸ì…˜ ì‚­ì œ ì˜¤ë¥˜:', error);
                showMessage('ë¯¸ì…˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë¯¸ì…˜ ìˆ˜ì •
        async function editMission(missionId) {
            const mission = missions.find(m => m.id === missionId);
            if (!mission) return;
            
            const newText = prompt('ë¯¸ì…˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”:', mission.text);
            if (!newText || newText.trim() === mission.text) return;
            
            try {
                await db.collection('missions').doc(missionId).update({
                    text: newText.trim(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showMessage('ë¯¸ì…˜ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadMissions();
                
            } catch (error) {
                console.error('ë¯¸ì…˜ ìˆ˜ì • ì˜¤ë¥˜:', error);
                showMessage('ë¯¸ì…˜ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë¯¸ì…˜ í¼ ì´ˆê¸°í™”
        function clearMissionForm() {
            document.getElementById('missionText').value = '';
        }

        // ê²Œì„ë°© í˜„í™© ë¡œë“œ
        async function loadRooms() {
            try {
                const snapshot = await db.collection('games').orderBy('createdAt', 'desc').get();
                gameRooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                updateRoomsList();
                
            } catch (error) {
                console.error('ê²Œì„ë°© ë¡œë“œ ì˜¤ë¥˜:', error);
                showMessage('ê²Œì„ë°© ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê²Œì„ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateRoomsList() {
            const listEl = document.getElementById('roomsList');
            
            if (gameRooms.length === 0) {
                listEl.innerHTML = '<div class="message info">ìƒì„±ëœ ê²Œì„ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '<div class="rooms-grid">';
            gameRooms.forEach(room => {
                const humanPlayers = room.players ? room.players.filter(p => !p.isAI) : [];
                const aiPlayers = room.players ? room.players.filter(p => p.isAI) : [];
                const statusClass = `status-${room.status || 'waiting'}`;
                const statusText = room.status === 'waiting' ? 'ëŒ€ê¸°ì¤‘' : 
                                 room.status === 'playing' ? 'ì§„í–‰ì¤‘' : 'ì¢…ë£Œ';
                
                html += `
                    <div class="room-card">
                        <div class="room-header">
                            <div class="room-code">${room.roomCode}</div>
                            <div class="room-status ${statusClass}">${statusText}</div>
                        </div>
                        
                        <div class="room-players">
                            ${humanPlayers.map(p => 
                                `<span class="player-name ${p.isHost ? 'host' : ''}">${p.nickname}</span>`
                            ).join('')}
                            ${aiPlayers.map(p => 
                                `<span class="player-name ai">${p.nickname}</span>`
                            ).join('')}
                        </div>
                        
                        <div class="room-info">
                            ìƒì„±: ${formatTime(room.createdAt)}
                        </div>
                        ${room.players ? room.players.map(p => 
                            `<div class="room-info" style="font-size: 0.7rem; color: #888;">
                                ${p.nickname}: ${p.cards ? p.cards.map(c => `${c.emoji}${c.number}`).join(' ') : 'ì¹´ë“œì—†ìŒ'} (${p.score || 0}ì )
                            </div>`
                        ).join('') : ''}
                        ${room.startedAt ? `<div class="room-info">ì‹œì‘: ${formatTime(room.startedAt)}</div>` : ''}
                        ${room.status === 'playing' ? `<div class="room-info">ë¼ìš´ë“œ: ${room.currentRound || 1}</div>` : ''}
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-secondary btn-small" onclick="viewRoomDetails('${room.id}')">ìƒì„¸ë³´ê¸°</button>
                            ${room.status === 'finished' ? 
                                `<button class="btn btn-danger btn-small" onclick="deleteRoom('${room.id}')">ì‚­ì œ</button>` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            listEl.innerHTML = html;
        }

        // ê²Œì„ë°© ìƒì„¸ë³´ê¸°
        function viewRoomDetails(roomId) {
            const room = gameRooms.find(r => r.id === roomId);
            if (!room) return;
            
            let details = `ê²Œì„ë°©: ${room.roomCode}\n`;
            details += `ìƒíƒœ: ${room.status}\n`;
            details += `ì°¸ê°€ì ìˆ˜: ${room.players ? room.players.length : 0}ëª…\n`;
            
            if (room.players) {
                details += `\nì°¸ê°€ì ëª©ë¡:\n`;
                room.players.forEach(player => {
                    details += `- ${player.nickname}`;
                    if (player.isHost) details += ' (ë°©ì¥)';
                    if (player.isAI) details += ' (AI)';
                    if (player.score) details += ` - ${player.score}ì `;
                    details += '\n';
                });
            }
            
            if (room.currentMission) {
                details += `\ní˜„ì¬ ë¯¸ì…˜: ${room.currentMission}`;
            }
            
            alert(details);
        }

        // ê²Œì„ë°© ì‚­ì œ
        async function deleteRoom(roomId) {
            if (!confirm('ì •ë§ë¡œ ì´ ê²Œì„ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await db.collection('games').doc(roomId).delete();
                showMessage('ê²Œì„ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadRooms();
                
            } catch (error) {
                console.error('ê²Œì„ë°© ì‚­ì œ ì˜¤ë¥˜:', error);
                showMessage('ê²Œì„ë°© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì™„ë£Œëœ ê²Œì„ë°© ì •ë¦¬
        async function cleanupFinishedRooms() {
            if (!confirm('ì™„ë£Œëœ ëª¨ë“  ê²Œì„ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const finishedRooms = gameRooms.filter(room => room.status === 'finished');
                const batch = db.batch();
                
                finishedRooms.forEach(room => {
                    batch.delete(db.collection('games').doc(room.id));
                });
                
                await batch.commit();
                showMessage(`${finishedRooms.length}ê°œì˜ ì™„ë£Œëœ ê²Œì„ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                loadRooms();
                
            } catch (error) {
                console.error('ê²Œì„ë°© ì •ë¦¬ ì˜¤ë¥˜:', error);
                showMessage('ê²Œì„ë°© ì •ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê²Œì„ë°© ìƒˆë¡œê³ ì¹¨
        function refreshRooms() {
            loadRooms();
            showMessage('ê²Œì„ë°© ëª©ë¡ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        // ê²Œì„ ì„¤ì • ë¡œë“œ
        function loadSettings() {
            // ê¸°ë³¸ê°’ë“¤ì„ UIì— ì„¤ì •
            document.getElementById('maxPlayers').value = 6;
            document.getElementById('maxRounds').value = 5;
            document.getElementById('autoAI').value = 'true';
            document.getElementById('cardsPerType').value = 5;
        }

        // ì„¤ì • ì—…ë°ì´íŠ¸
        async function updateSetting(settingName) {
            const element = document.getElementById(settingName);
            const value = element.type === 'number' ? parseInt(element.value) : element.value;
            
            try {
                // ê¸€ë¡œë²Œ ì„¤ì •ì„ Firestoreì— ì €ì¥
                await db.collection('settings').doc('global').set({
                    [settingName]: value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                showMessage(`${settingName} ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                
            } catch (error) {
                console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
                showMessage('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê²Œì„ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        async function exportGameData() {
            try {
                const gamesSnapshot = await db.collection('games').get();
                const missionsSnapshot = await db.collection('missions').get();
                
                const exportData = {
                    games: gamesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    missions: missionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    exportedAt: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `praise-card-game-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage('ê²Œì„ ë°ì´í„°ê°€ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
            } catch (error) {
                console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                showMessage('ë°ì´í„° ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬
        async function clearOldData() {
            if (!confirm('30ì¼ ì´ì „ì˜ ì™„ë£Œëœ ê²Œì„ë°©ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const oldGamesSnapshot = await db.collection('games')
                    .where('status', '==', 'finished')
                    .where('createdAt', '<', thirtyDaysAgo)
                    .get();
                
                const batch = db.batch();
                oldGamesSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                showMessage(`${oldGamesSnapshot.size}ê°œì˜ ì˜¤ë˜ëœ ê²Œì„ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                loadRooms();
                
            } catch (error) {
                console.error('ë°ì´í„° ì •ë¦¬ ì˜¤ë¥˜:', error);
                showMessage('ë°ì´í„° ì •ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë°ì´í„° ë°±ì—…
        async function backupData() {
            try {
                // í˜„ì¬ëŠ” ë‚´ë³´ë‚´ê¸°ì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
                await exportGameData();
                showMessage('ë°ì´í„°ê°€ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
            } catch (error) {
                console.error('ë°±ì—… ì˜¤ë¥˜:', error);
                showMessage('ë°±ì—…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
        function startRealtimeListener() {
            realtimeListener = db.collection('games')
                .where('status', 'in', ['waiting', 'playing'])
                .onSnapshot((snapshot) => {
                    // ëŒ€ì‹œë³´ë“œ íƒ­ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadDashboard();
                    }
                });
        }

        // ì‹œê°„ í¬ë§·íŒ…
        function formatTime(timestamp) {
            if (!timestamp) return 'ì•Œ ìˆ˜ ì—†ìŒ';
            
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else {
                date = new Date(timestamp);
            }
            
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (minutes < 1) return 'ë°©ê¸ˆ ì „';
            if (minutes < 60) return `${minutes}ë¶„ ì „`;
            if (hours < 24) return `${hours}ì‹œê°„ ì „`;
            if (days < 7) return `${days}ì¼ ì „`;
            
            return date.toLocaleDateString('ko-KR');
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = text;
            
            messageArea.appendChild(messageEl);
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 5000);
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ
            window.scrollTo(0, 0);
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (realtimeListener) {
                realtimeListener();
            }
        });

        // Enter í‚¤ë¡œ ë¯¸ì…˜ ì¶”ê°€
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id === 'missionText') {
                addMission();
            }
        });

        async function resetAllGames() {
    if (!confirm('ì •ë§ë¡œ ëª¨ë“  ê²Œì„ì„ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) return;
    if (!confirm('ì§„ì§œë¡œ í™•ì‹¤í•©ë‹ˆê¹Œ? ëª¨ë“  ê²Œì„ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!')) return;
    
    try {
        const gamesSnapshot = await db.collection('games').get();
        const batch = db.batch();
        
        gamesSnapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        showMessage(`${gamesSnapshot.size}ê°œì˜ ê²Œì„ì´ ëª¨ë‘ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        loadRooms();
        loadDashboard();
        
    } catch (error) {
        console.error('ê²Œì„ ë¦¬ì…‹ ì˜¤ë¥˜:', error);
        showMessage('ê²Œì„ ë¦¬ì…‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}
    </script>
</body>
</html>
