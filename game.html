<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>칭찬카드게임</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 10px;
            font-size: 16px;
        }

        /* 게임 화면에서 자동 가로모드 */
        @media screen and (orientation: portrait) and (max-width: 768px) {
            .game-screen-active body {
                transform: rotate(90deg);
                transform-origin: left top;
                width: 100vh;
                height: 100vw;
                overflow-x: hidden;
                position: absolute;
                top: 100%;
                left: 0;
            }
        }

        .game-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .room-info {
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .room-code {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4ecdc4;
            letter-spacing: 2px;
        }

        /* 턴 순서 표시 */
        .turn-order {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .turn-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .turn-player {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .turn-player.current-king {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #333;
            font-weight: bold;
            transform: scale(1.1);
        }

        .turn-player.my-turn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            font-weight: bold;
        }

        .turn-player.ai-player {
            background: rgba(255,255,255,0.3);
            font-style: italic;
        }

        /* 게임 상태 정보 */
        .game-status {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .status-row:last-child {
            margin-bottom: 0;
        }

        .status-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .status-value {
            font-weight: bold;
            font-size: 1rem;
        }

        /* 대기실 */
        .waiting-room {
            text-align: center;
            padding: 20px;
        }

        .waiting-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }

        .players-waiting {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
        }

        .player-item:last-child {
            margin-bottom: 0;
        }

        .player-name {
            font-weight: bold;
        }

        .host-badge {
            background: #ffd700;
            color: #333;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .ai-badge {
            background: #666;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
        }

        /* 카드 스타일 */
        .card {
            width: 75px;
            height: 110px;
            background: white;
            border-radius: 10px;
            border: 2px solid #ddd;
            display: flex;
            flex-direction: column;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
            user-select: none;
            margin: 3px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .card.selected {
            transform: translateY(-15px);
            border-color: #ff6b6b;
            box-shadow: 0 12px 30px rgba(255,107,107,0.4);
        }

        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .card-number-top {
            position: absolute;
            top: 5px;
            left: 8px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .card-number-bottom {
            position: absolute;
            bottom: 5px;
            right: 8px;
            font-size: 0.8rem;
            font-weight: bold;
            transform: rotate(180deg);
        }

        .card-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 8px;
        }

        .card-emoji {
            font-size: 1.1rem;
            line-height: 1.1;
            text-align: center;
        }

        .joker-card {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
        }

        .bomb-joker {
            background: linear-gradient(45deg, #ff4757, #ff3838);
        }

        /* 조합할 카드 영역 */
        .selected-cards-area {
            min-height: 120px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 2px dashed rgba(255,255,255,0.3);
        }

        .selected-cards {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .combination-info {
            text-align: center;
            font-size: 0.9rem;
            line-height: 1.3;
            min-height: 20px;
        }

        /* 내 카드 영역 */
        .my-cards-area {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 15px;
        }

        .my-cards {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .section-title {
            text-align: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* 액션 버튼들 */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-king {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #333;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* 왕 모드 UI */
        .king-mode {
            background: rgba(255,215,0,0.2);
            border: 2px solid #ffd700;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .king-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #ffd700;
        }

        .king-mission {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            line-height: 1.4;
            font-size: 0.9rem;
        }

        /* 플레이어 선택 UI */
        .players-selection {
            margin-top: 10px;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }

        .player-card {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-size: 0.8rem;
        }

        .player-card:hover {
            background: rgba(255,255,255,0.2);
        }

        .player-card.selected {
            background: rgba(255,107,107,0.2);
            border-color: #ff6b6b;
        }

        .selection-status {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .king-buttons {
            display: flex;
            gap: 8px;
        }

        /* AI 진행 표시 */
        .ai-thinking {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* 미션 팝업 */
        .mission-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .mission-content {
            background: white;
            color: #333;
            padding: 25px;
            border-radius: 15px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .mission-text {
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .hidden {
            display: none;
        }

        /* 게임 모드별 숨김 */
        .king-only {
            display: none;
        }

        .player-only {
            display: block;
        }

        .is-king .king-only {
            display: block;
        }

        .is-king .player-only {
            display: none;
        }

        /* 로딩 및 에러 */
        .loading-screen {
            text-align: center;
            padding: 50px 20px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #4ecdc4;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-screen {
            text-align: center;
            padding: 50px 20px;
        }

        .error-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #ff6b6b;
        }

        /* 반응형 */
        @media (max-width: 480px) {
            .card {
                width: 65px;
                height: 95px;
            }
            
            .card-emoji {
                font-size: 0.9rem;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <!-- 로딩 화면 -->
        <div id="loadingScreen" class="loading-screen">
            <div class="spinner"></div>
            <h2>게임 연결 중...</h2>
            <p>잠시만 기다려주세요.</p>
        </div>

        <!-- 에러 화면 -->
        <div id="errorScreen" class="error-screen hidden">
            <div class="error-title">🚫 연결 오류</div>
            <p id="errorMessage">게임방에 연결할 수 없습니다.</p>
            <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                메인으로 돌아가기
            </button>
        </div>

        <!-- 대기실 -->
        <div id="waitingRoom" class="waiting-room hidden">
            <div class="header">
                <h1>🎉 칭찬카드게임</h1>
                <div class="room-info">
                    <div>게임방 코드</div>
                    <div class="room-code" id="roomCodeDisplay">A1B2</div>
                </div>
            </div>

            <div class="waiting-title">플레이어 대기 중...</div>
            
            <div class="players-waiting">
                <div id="waitingPlayersList"></div>
            </div>

            <div id="hostControls" class="hidden">
                <button class="btn btn-primary" onclick="startGame()" id="startGameBtn" disabled>
                    게임 시작하기 (최소 4명)
                </button>
            </div>

            <div id="guestMessage">
                <p>방장이 게임을 시작할 때까지 기다려주세요.</p>
            </div>
        </div>

        <!-- 게임 화면 -->
        <div id="gameScreen" class="hidden">
            <div class="header">
                <h1>🎉 칭찬카드게임</h1>
                <div class="room-info">
                    <div class="room-code" id="gameRoomCode">A1B2</div>
                </div>
            </div>

            <!-- 턴 순서 -->
            <div class="turn-order">
                <div class="status-label" style="margin-bottom: 8px;">왕 순서</div>
                <div class="turn-indicator" id="turnIndicator"></div>
            </div>

            <!-- 게임 상태 -->
            <div class="game-status">
                <div class="status-row">
                    <span class="status-label">내 점수</span>
                    <span class="status-value" id="myScore">0점</span>
                </div>
                <div class="status-row">
                    <span class="status-label">라운드</span>
                    <span class="status-value" id="currentRound">1 / 5</span>
                </div>
            </div>

            <!-- AI 진행 표시 -->
            <div id="aiThinking" class="ai-thinking hidden">
                <div>🤖 AI가 생각 중입니다...</div>
            </div>

            <!-- 왕 모드 UI -->
            <div class="king-mode king-only">
                <div class="king-title">👑 당신이 왕입니다!</div>
                <div class="king-mission" id="kingMission">
                    미션을 읽고 다른 플레이어들의 칭찬을 들어보세요.
                </div>
                
                <div class="players-selection">
                    <div class="selection-status" id="selectionStatus">칭찬해준 플레이어 2명을 선택하세요 (0/2)</div>
                    <div class="players-grid" id="playersGrid"></div>
                    
                    <div class="king-buttons">
                        <button class="btn btn-king" id="kingSelectBtn" onclick="completeKingSelection()" disabled>
                            선택 완료
                        </button>
                        <button class="btn btn-secondary" id="kingResetBtn" onclick="resetPlayerSelection()">
                            선택 초기화
                        </button>
                    </div>
                </div>
            </div>

            <!-- 플레이어 모드 UI -->
            <div class="player-only">
                <!-- 조합할 카드 영역 -->
                <div class="selected-cards-area">
                    <div class="section-title">조합할 카드</div>
                    <div class="selected-cards" id="selectedCards"></div>
                    <div class="combination-info" id="combinationInfo">카드를 선택하면 점수가 표시됩니다</div>
                </div>

                <!-- 내 카드 영역 -->
                <div class="my-cards-area">
                    <div class="section-title">내 카드</div>
                    <div class="my-cards" id="myCards"></div>
                </div>

                <!-- 액션 버튼들 -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="submitCombination" onclick="submitCombination()" disabled>
                        조합 완성 (0점)
                    </button>
                    <button class="btn btn-secondary" id="discardCard" onclick="discardCard()" disabled>
                        카드 1장 버리기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 미션 팝업 -->
    <div class="mission-popup hidden" id="missionPopup">
        <div class="mission-content">
            <h2>👑 새로운 미션</h2>
            <div class="mission-text" id="missionText"></div>
            <button class="btn btn-primary" onclick="closeMissionPopup()">시작!</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyC3IwL7hYsWIT6wRpenGXwqvSBtV_WIx-M",
            authDomain: "complimentcardgame.firebaseapp.com",
            projectId: "complimentcardgame",
            storageBucket: "complimentcardgame.firebasestorage.app",
            messagingSenderId: "766205964734",
            appId: "1:766205964734:web:0aa711ffc46f96e51889ef",
            measurementId: "G-P7KM5ETH2J"
        };

        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 전역 변수
        let currentUser = null;
        let currentRoomCode = null;
        let gameData = null;
        let myPlayerData = null;
        let selectedCards = [];
        let selectedPlayers = [];
        let gameListener = null;

        // 카드 타입 정의
        const cardTypes = {
            animals: ['🐶', '🐱', '🐰', '🐸'],
            fruits: ['🍎', '🍌', '🍇', '🍓']
        };

        const missions = [
            "내가 어려운 상황에서 침착하게 대처했던 순간은?",
            "내가 팀원들에게 도움이 되었던 경험은?",
            "내가 창의적인 아이디어를 제시했던 때는?",
            "내가 리더십을 발휘했던 모습은?",
            "내가 꼼꼼하고 책임감 있게 일했던 경우는?",
            "내가 긍정적인 에너지를 전달했던 순간은?",
            "내가 문제 해결 능력을 보여준 사례는?",
            "내가 소통을 잘했던 경험은?",
            "내가 성장하는 모습을 보여준 때는?",
            "내가 배려심을 발휘했던 순간은?",
            "내가 동료들을 격려했던 경험은?",
            "내가 새로운 것을 학습하는 모습을 보여준 때는?",
            "내가 책임감 있게 업무를 마무리한 경험은?",
            "내가 팀워크를 발휘했던 순간은?",
            "내가 유머로 분위기를 좋게 만든 경험은?"
        ];

        // URL에서 방 코드 가져오기
        function getRoomCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('room');
        }

        // 카드 생성 함수
        function createCard(type, emoji, number, isJoker = false) {
            return {
                type: type,
                emoji: emoji,
                number: number,
                isJoker: isJoker,
                id: Math.random().toString(36).substr(2, 9)
            };
        }

        // 초기 카드 덱 생성
        function createInitialDeck() {
            const deck = [];
            
            // 동물 카드
            cardTypes.animals.forEach(emoji => {
                for(let i = 1; i <= 5; i++) {
                    deck.push(createCard('animal', emoji, i));
                }
            });
            
            // 과일 카드
            cardTypes.fruits.forEach(emoji => {
                for(let i = 1; i <= 5; i++) {
                    deck.push(createCard('fruit', emoji, i));
                }
            });
            
            // 조커 카드
            deck.push(createCard('joker', '⭐', 0, 'good'));
            deck.push(createCard('joker', '💣', 0, 'bomb'));
            
            return deck;
        }

        // 카드 셔플
        function shuffleDeck(deck) {
            for(let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        // AI 플레이어 생성
        function createAIPlayer(index) {
            return {
                id: `ai_${index}`,
                nickname: `AI봇${index}`,
                isHost: false,
                isAI: true,
                joinedAt: new Date(),
                score: 0,
                cards: []
            };
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            currentRoomCode = getRoomCodeFromURL();
            
            if (!currentRoomCode) {
                showError('게임방 코드가 없습니다.');
                return;
            }

            try {
                // 익명 로그인
                await auth.signInAnonymously();
                currentUser = auth.currentUser;
                
                // 게임방 연결
                connectToGame();
                
            } catch (error) {
                console.error('로그인 오류:', error);
                showError('로그인에 실패했습니다.');
            }
        });

        // 게임방 연결
        function connectToGame() {
            gameListener = db.collection('games').doc(currentRoomCode).onSnapshot(
                (doc) => {
                    if (!doc.exists) {
                        showError('존재하지 않는 게임방입니다.');
                        return;
                    }

                    gameData = doc.data();
                    myPlayerData = gameData.players.find(p => p.id === currentUser.uid);
                    
                    if (!myPlayerData) {
                        showError('이 게임방에 참가하지 않았습니다.');
                        return;
                    }

                    updateGameDisplay();
                },
                (error) => {
                    console.error('게임 데이터 리스닝 오류:', error);
                    showError('게임 연결에 실패했습니다.');
                }
            );
        }

        // 게임 화면 업데이트
        function updateGameDisplay() {
            if (gameData.status === 'waiting') {
                showWaitingRoom();
            } else if (gameData.status === 'playing') {
                showGameScreen();
            } else {
                showError('게임이 종료되었습니다.');
            }
        }

        // 대기실 표시
        function showWaitingRoom() {
            hideAllScreens();
            document.getElementById('waitingRoom').classList.remove('hidden');
            document.getElementById('roomCodeDisplay').textContent = currentRoomCode;
            
            updateWaitingPlayersList();
            
            // 방장 권한 확인
            if (myPlayerData.isHost) {
                document.getElementById('hostControls').classList.remove('hidden');
                document.getElementById('guestMessage').classList.add('hidden');
                
                const startBtn = document.getElementById('startGameBtn');
                const canStart = gameData.players.length >= 1;
                startBtn.disabled = !canStart;
                startBtn.textContent = `게임 시작하기 (${gameData.players.length}명, AI ${Math.max(0, 4 - gameData.players.length)}명 추가)`;
            } else {
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('guestMessage').classList.remove('hidden');
            }
        }

        // 대기실 플레이어 목록 업데이트
        function updateWaitingPlayersList() {
            const listEl = document.getElementById('waitingPlayersList');
            listEl.innerHTML = gameData.players.map(player => `
                <div class="player-item">
                    <span class="player-name">${player.nickname}</span>
                    <div>
                        ${player.isHost ? '<span class="host-badge">방장</span>' : ''}
                        ${player.isAI ? '<span class="ai-badge">AI</span>' : ''}
                    </div>
                </div>
            `).join('');
        }

        // 게임 시작 (방장만)
        async function startGame() {
            if (!myPlayerData.isHost) return;

            try {
                let players = [...gameData.players];
                
                // 2명 미만이면 AI 추가
                while (players.length < 4) {
                    const aiIndex = players.filter(p => p.isAI).length + 1;
                    players.push(createAIPlayer(aiIndex));
                }
                
                // 카드 덱 생성 및 셔플 (매우 중요!)
                const deck = shuffleDeck(createInitialDeck());
                
                console.log('생성된 덱 길이:', deck.length);
                console.log('덱 샘플:', deck.slice(0, 10).map(c => `${c.emoji}${c.number}`));
                
                // 각 플레이어에게 5장씩 순서대로 배분
                players.forEach((player, playerIndex) => {
                    player.cards = [];
                    for(let i = 0; i < 5; i++) {
                        if(deck.length > 0) {
                            const card = deck.shift(); // shift로 앞에서부터 가져오기
                            player.cards.push(card);
                        }
                    }
                    player.score = 0;
                    console.log(`플레이어 ${playerIndex + 1} (${player.nickname}) 카드:`, 
                        player.cards.map(c => `${c.emoji}${c.number}`));
                });

                console.log('배분 후 덱 잔여:', deck.length);

                // 첫 미션 설정
                const firstMission = missions[Math.floor(Math.random() * missions.length)];

                // 게임 상태 업데이트
                await db.collection('games').doc(currentRoomCode).update({
                    status: 'playing',
                    players: players,
                    deck: deck,
                    currentMission: firstMission,
                    currentKingIndex: 0,
                    currentRound: 1,
                    selectedPlayers: [],
                    startedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            } catch (error) {
                console.error('게임 시작 오류:', error);
                alert('게임 시작에 실패했습니다.');
            }
        }

        // 게임 화면 표시
        function showGameScreen() {
            hideAllScreens();
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('gameRoomCode').textContent = currentRoomCode;
            document.body.classList.add('game-screen-active');
            
            updateGameUI();
            
        }

        // 게임 UI 업데이트
        function updateGameUI() {
            const container = document.getElementById('gameContainer');
            const currentKing = gameData.players[gameData.currentKingIndex];
            const isMyTurnAsKing = currentKing && currentKing.id === currentUser.uid;
            
            // 왕 모드/플레이어 모드 설정
            if (isMyTurnAsKing) {
                container.classList.add('is-king');
                updateKingModeUI();
                
                // 새 미션일 때 팝업 표시
            if (gameData.currentMission && document.getElementById('missionPopup').classList.contains('hidden')) {
                setTimeout(showMissionPopup, 1000);
               }
            } else {
                container.classList.remove('is-king');
                updatePlayerModeUI();
                
            // AI 턴인지 확인하고 AI 로직 실행
            if (currentKing && currentKing.isAI) {
                handleAITurn();
            } else if (!isMyTurnAsKing) {
                // AI 카드 플레이 (왕 턴이 아닐 때)
                setTimeout(() => {
                    handleAICardPlay();
                }, 1000);
            }
            updateTurnIndicator();
            updateGameStatus();
        }

        // 왕 모드 UI 업데이트
        function updateKingModeUI() {
            document.getElementById('kingMission').textContent = gameData.currentMission;
            document.getElementById('selectionStatus').textContent = 
                `칭찬해준 플레이어 2명을 선택하세요 (${selectedPlayers.length}/2)`;
            
            // 플레이어 선택 그리드 (자신과 AI 제외)
            const playersGrid = document.getElementById('playersGrid');
            const selectablePlayers = gameData.players.filter(p => p.id !== currentUser.uid); // AI도 선택 가능하도록
            
            console.log('선택 가능한 플레이어들:', selectablePlayers.map(p => p.nickname));
            console.log('현재 선택된 플레이어들:', selectedPlayers);
            
            playersGrid.innerHTML = selectablePlayers.map(player => {
                const isSelected = selectedPlayers.includes(player.id);
                return `
                    <div class="player-card ${isSelected ? 'selected' : ''}" 
                         onclick="togglePlayerSelection('${player.id}')">
                        <div class="player-name">${player.nickname}</div>
                        ${isSelected ? '<div style="color: #ff6b6b;">✓ 선택됨</div>' : '<div>클릭하여 선택</div>'}
                    </div>
                `;
            }).join('');
            
            // 버튼 상태
            document.getElementById('kingSelectBtn').disabled = selectedPlayers.length !== 2;
        }

        // 플레이어 선택 토글 (새로운 함수)
        function togglePlayerSelection(playerId) {
            const isMyTurnAsKing = gameData.currentKingIndex === gameData.players.findIndex(p => p.id === currentUser.uid);
            if(!isMyTurnAsKing) return;
            
            console.log('플레이어 선택 토글:', playerId);
            console.log('현재 선택된 플레이어들:', selectedPlayers);
            
            const isSelected = selectedPlayers.includes(playerId);
            
            if(isSelected) {
                // 선택 해제
                selectedPlayers = selectedPlayers.filter(id => id !== playerId);
            } else {
                // 선택 추가 (최대 2명까지)
                if(selectedPlayers.length < 2) {
                    selectedPlayers.push(playerId);
                }
            }
            
            console.log('업데이트된 선택 플레이어들:', selectedPlayers);
            updateKingModeUI();
        }

        // 플레이어 모드 UI 업데이트
        function updatePlayerModeUI() {
            // 내 카드 표시
            const myCardsEl = document.getElementById('myCards');
            const myCards = myPlayerData.cards || [];
            
            myCardsEl.innerHTML = myCards.map(card => {
                const isSelected = selectedCards.some(c => c.id === card.id);
                let cardHTML = createCardHTML(card, false);
                
                if(isSelected) {
                    cardHTML = cardHTML.replace('class="card', 'class="card selected');
                }
                
                return cardHTML;
            }).join('');
            
            // 선택된 카드 표시
            const selectedCardsEl = document.getElementById('selectedCards');
            selectedCardsEl.innerHTML = selectedCards.map(card => createCardHTML(card, true)).join('');
            
            // 조합 정보 표시
            const combination = calculateCombinationScore(selectedCards);
            const combinationInfo = document.getElementById('combinationInfo');
            
            if(selectedCards.length === 0) {
                combinationInfo.textContent = "카드를 선택하여 조합을 만드세요";
            } else if(combination.score === 0) {
                combinationInfo.textContent = "";
            } else {
                combinationInfo.textContent = combination.description;
            }
            
            // 버튼 상태 업데이트
            const submitBtn = document.getElementById('submitCombination');
            const discardBtn = document.getElementById('discardCard');
            
            const canSubmitCombination = combination.score > 0;
            const canDiscardCard = selectedCards.length === 1 && myCards.length > 5;
            
            submitBtn.disabled = !canSubmitCombination;
            submitBtn.textContent = `조합 완성 (${combination.score}점)`;
            
            discardBtn.disabled = !canDiscardCard;
            if (myCards.length > 5) {
                discardBtn.textContent = "카드 1장 버리기 (필수)";
            } else {
                discardBtn.textContent = "카드 1장 버리기";
            }
        }

        // 턴 순서 표시 업데이트
        function updateTurnIndicator() {
            const turnIndicator = document.getElementById('turnIndicator');
            turnIndicator.innerHTML = gameData.players.map((player, index) => {
                let className = 'turn-player';
                if(index === gameData.currentKingIndex) {
                    className += ' current-king';
                } else if(player.id === currentUser.uid) {
                    className += ' my-turn';
                }
                if(player.isAI) {
                    className += ' ai-player';
                }
                
                return `<div class="${className}">${player.nickname}</div>`;
            }).join('');
        }

        // 게임 상태 업데이트
        function updateGameStatus() {
            document.getElementById('myScore').textContent = `${myPlayerData.score || 0}점`;
            
            const totalRounds = gameData.players.length;
            document.getElementById('currentRound').textContent = `${gameData.currentRound} / ${totalRounds}`;
        }

        // 카드 HTML 생성
        function createCardHTML(card, disabled = false) {
            const isJoker = card.isJoker;
            const jokerClass = isJoker ? (card.isJoker === 'bomb' ? 'joker-card bomb-joker' : 'joker-card') : '';
            const disabledClass = disabled ? 'disabled' : '';
            
            let emojiDisplay = '';
            if(isJoker) {
                emojiDisplay = card.emoji;
            } else {
                // 이모지 개수를 실제 숫자만큼 표시하되, 줄바꿈으로 배치
                const emojiArray = Array(card.number).fill(card.emoji);
                if(card.number <= 3) {
                    emojiDisplay = emojiArray.join('');
                } else if(card.number === 4) {
                    emojiDisplay = emojiArray.slice(0, 2).join('') + '<br>' + emojiArray.slice(2, 4).join('');
                } else { // 5개
                    emojiDisplay = emojiArray.slice(0, 2).join('') + '<br>' + card.emoji + '<br>' + emojiArray.slice(3, 5).join('');
                }
            }
            
            return `
                <div class="card ${jokerClass} ${disabledClass}" data-id="${card.id}" onclick="${disabled ? '' : `toggleCardSelection('${card.id}')`}">
                    ${!isJoker ? `<div class="card-number-top">${card.number}</div>` : ''}
                    <div class="card-center">
                        <div class="card-emoji">${emojiDisplay}</div>
                    </div>
                    ${!isJoker ? `<div class="card-number-bottom">${card.number}</div>` : ''}
                </div>
            `;
        }

        // 카드 조합 점수 계산
        function calculateCombinationScore(cards) {
            if(cards.length < 2) return { score: 0, description: '카드를 2장 이상 선택하세요' };
            
            const jokers = cards.filter(c => c.isJoker);
            const normalCards = cards.filter(c => !c.isJoker);
            
            if(normalCards.length === 0) return { score: 0, description: '일반 카드가 필요합니다' };
            
            let baseScore = 0;
            let description = '';
            
            // 같은 숫자 조합 확인
            const numberGroups = {};
            normalCards.forEach(card => {
                if(!numberGroups[card.number]) numberGroups[card.number] = [];
                numberGroups[card.number].push(card);
            });
            
            const numberGroupSizes = Object.values(numberGroups).map(group => group.length);
            const maxSameNumber = Math.max(...numberGroupSizes);
            
            if(maxSameNumber >= 2) {
                const scores = { 2: 2, 3: 5, 4: 10, 5: 20 };
                baseScore = scores[maxSameNumber] || 0;
                description = `같은 숫자 ${maxSameNumber}장 (${baseScore}점)`;
                
                // 특별 조합 확인 (같은 숫자 4장)
                if(maxSameNumber === 4) {
                    const sameNumberCards = Object.values(numberGroups).find(group => group.length === 4);
                    const types = sameNumberCards.map(card => card.type);
                    const isAllAnimals = types.every(type => type === 'animal');
                    const isAllFruits = types.every(type => type === 'fruit');
                    
                    if(isAllAnimals || isAllFruits) {
                        baseScore = 20;
                        description = isAllAnimals ? '동물농장 (20점)' : '과일가게 (20점)';
                    }
                }
            }
            
            // 연속 숫자 확인 (같은 이모지)
            const emojiGroups = {};
            normalCards.forEach(card => {
                if(!emojiGroups[card.emoji]) emojiGroups[card.emoji] = [];
                emojiGroups[card.emoji].push(card.number);
            });
            
            for(let emoji in emojiGroups) {
                const numbers = [...new Set(emojiGroups[emoji])].sort((a,b) => a-b);
                let consecutive = 1;
                let maxConsecutive = 1;
                
                for(let i = 1; i < numbers.length; i++) {
                    if(numbers[i] === numbers[i-1] + 1) {
                        consecutive++;
                        maxConsecutive = Math.max(maxConsecutive, consecutive);
                    } else {
                        consecutive = 1;
                    }
                }
                
                if(maxConsecutive >= 3) {
                    const sequenceScore = 5;
                    if(sequenceScore > baseScore) {
                        baseScore = sequenceScore;
                        description = `연속 ${maxConsecutive}장 (${sequenceScore}점)`;
                    }
                }
                
                // 풀세트 확인 (1~5)
                if(numbers.length === 5 && numbers.every((num, idx) => num === idx + 1)) {
                    baseScore = 30;
                    description = `풀세트 1~5 (30점)`;
                }
            }
            
            // 조커 효과 적용
            let finalScore = baseScore;
            if(jokers.length > 0) {
                const hasGoodJoker = jokers.some(j => j.isJoker === 'good');
                if(hasGoodJoker && baseScore > 0) {
                    finalScore = baseScore * 2;
                    description += ' (⭐조커 2배!)';
                }
            }
            
            return { score: finalScore, description };
        }

        // 카드 선택 토글
        function toggleCardSelection(cardId) {
            const isMyTurnAsKing = gameData.currentKingIndex === gameData.players.findIndex(p => p.id === currentUser.uid);
            if(isMyTurnAsKing) return;
            
            const card = myPlayerData.cards.find(c => c.id === cardId);
            if(!card) return;
            
            const isSelected = selectedCards.some(c => c.id === cardId);
            
            if(isSelected) {
                selectedCards = selectedCards.filter(c => c.id !== cardId);
            } else {
                selectedCards.push(card);
            }
            
            updatePlayerModeUI();
        }

        // 기존 함수들 제거하고 새로운 togglePlayerSelection 사용
        // (selectPlayer, unselectPlayer 함수는 더 이상 필요 없음)

        // 플레이어 선택 초기화
        function resetPlayerSelection() {
            const isMyTurnAsKing = gameData.currentKingIndex === gameData.players.findIndex(p => p.id === currentUser.uid);
            if(!isMyTurnAsKing) return;
            
            selectedPlayers = [];
            updateKingModeUI();
        }

        // 조합 완성
        async function submitCombination() {
            const isMyTurnAsKing = gameData.currentKingIndex === gameData.players.findIndex(p => p.id === currentUser.uid);
            if(isMyTurnAsKing) return;
            
            const combination = calculateCombinationScore(selectedCards);
            if(combination.score <= 0) return;

            try {
                // 플레이어 데이터 업데이트
                const updatedPlayers = [...gameData.players];
                const myIndex = updatedPlayers.findIndex(p => p.id === currentUser.uid);
                
                // 점수 추가
                updatedPlayers[myIndex].score = (updatedPlayers[myIndex].score || 0) + combination.score;
                
                // 선택된 카드들을 내 카드에서 제거
                selectedCards.forEach(selectedCard => {
                    updatedPlayers[myIndex].cards = updatedPlayers[myIndex].cards.filter(card => card.id !== selectedCard.id);
                });
                
                // 제거된 카드들을 덱에 다시 추가
                const updatedDeck = [...gameData.deck, ...selectedCards];
                
                // Firestore 업데이트
                await db.collection('games').doc(currentRoomCode).update({
                    players: updatedPlayers,
                    deck: updatedDeck
                });
                
                selectedCards = [];
                alert(`${combination.description}\n${combination.score}점 획득!`);
                
            } catch (error) {
                console.error('조합 완성 오류:', error);
                alert('조합 완성에 실패했습니다.');
            }
        }

        // 카드 버리기
        async function discardCard() {
            const isMyTurnAsKing = gameData.currentKingIndex === gameData.players.findIndex(p => p.id === currentUser.uid);
            if(isMyTurnAsKing) return;
            
            if(selectedCards.length !== 1) return;

            try {
                const discardedCard = selectedCards[0];
                
                // 플레이어 데이터 업데이트
                const updatedPlayers = [...gameData.players];
                const myIndex = updatedPlayers.findIndex(p => p.id === currentUser.uid);
                
                // 선택된 카드를 내 카드에서 제거
                updatedPlayers[myIndex].cards = updatedPlayers[myIndex].cards.filter(card => card.id !== discardedCard.id);
                
                // 버린 카드를 덱에 다시 추가
                const updatedDeck = [...gameData.deck, discardedCard];
                
                // Firestore 업데이트
                await db.collection('games').doc(currentRoomCode).update({
                    players: updatedPlayers,
                    deck: updatedDeck
                });
                
                selectedCards = [];
                alert('카드 1장을 버렸습니다.');
                
            } catch (error) {
                console.error('카드 버리기 오류:', error);
                alert('카드 버리기에 실패했습니다.');
            }
        }

        // 왕 선택 완료
        async function completeKingSelection() {
            const isMyTurnAsKing = gameData.currentKingIndex === gameData.players.findIndex(p => p.id === currentUser.uid);
            if(!isMyTurnAsKing || selectedPlayers.length !== 2) return;

            try {
                // 선택받은 플레이어들에게 카드 배분
                const updatedPlayers = [...gameData.players];
                let updatedDeck = [...gameData.deck];
                
                selectedPlayers.forEach(playerId => {
                    const playerIndex = updatedPlayers.findIndex(p => p.id === playerId);
                    if(playerIndex !== -1 && updatedDeck.length > 0) {
                        // 덱에서 카드 1장 가져오기
                        const newCard = updatedDeck.pop();
                        updatedPlayers[playerIndex].cards.push(newCard);
                    }
                });
                
                // 다음 왕으로 턴 넘기기
                const nextKingIndex = (gameData.currentKingIndex + 1) % gameData.players.length;
                let nextRound = gameData.currentRound;
                
                // 한 바퀴 돌면 라운드 증가
                if(nextKingIndex === 0) {
                    nextRound++;
                }
                
                // 새 미션 설정
                const newMission = missions[Math.floor(Math.random() * missions.length)];
                
                // Firestore 업데이트
                await db.collection('games').doc(currentRoomCode).update({
                    players: updatedPlayers,
                    deck: updatedDeck,
                    currentKingIndex: nextKingIndex,
                    currentRound: nextRound,
                    currentMission: newMission,
                    selectedPlayers: []
                });
                
                const selectedPlayerNames = selectedPlayers.map(id => 
                    gameData.players.find(p => p.id === id).nickname
                );
                
                alert(`${selectedPlayerNames.join(', ')}님이 선택되었습니다!`);
                selectedPlayers = [];
                
            } catch (error) {
                console.error('왕 선택 완료 오류:', error);
                alert('선택 완료에 실패했습니다.');
            }
        }

            // AI 턴 처리 (게임 시작 시 즉시 실행되도록 수정)
            function handleAITurn() {
                const currentKing = gameData.players[gameData.currentKingIndex];
                if (!currentKing || !currentKing.isAI) return;
                
                console.log('AI 턴 시작:', currentKing.nickname);
                
                // AI 생각 중 표시
                document.getElementById('aiThinking').classList.remove('hidden');
                
                // 3초 후 AI 행동
                setTimeout(async () => {
                    try {
                        // 사용자 플레이어들 중에서 랜덤하게 2명 선택
                        const humanPlayers = gameData.players.filter(p => !p.isAI);
                        console.log('AI가 선택할 수 있는 인간 플레이어들:', humanPlayers.map(p => p.nickname));
                        
                        let aiSelectedPlayers = [];
                        
                        if(humanPlayers.length >= 2) {
                            // 인간 플레이어가 2명 이상이면 그 중에서 선택
                            const shuffledHumans = [...humanPlayers].sort(() => 0.5 - Math.random());
                            aiSelectedPlayers = shuffledHumans.slice(0, 2).map(p => p.id);
                        } else if(humanPlayers.length === 1) {
                            // 인간 플레이어가 1명이면 그 1명과 다른 AI 1명 선택
                            const otherAIs = gameData.players.filter(p => p.isAI && p.id !== currentKing.id);
                            aiSelectedPlayers = [humanPlayers[0].id];
                            if(otherAIs.length > 0) {
                                aiSelectedPlayers.push(otherAIs[0].id);
                            }
                        } else {
                            // 인간 플레이어가 없으면 다른 AI 2명 선택
                            const otherAIs = gameData.players.filter(p => p.isAI && p.id !== currentKing.id);
                            aiSelectedPlayers = otherAIs.slice(0, 2).map(p => p.id);
                        }
                        
                        console.log('AI가 선택한 플레이어들:', aiSelectedPlayers);
                        
                        // 선택받은 플레이어들에게 카드 배분
                        const updatedPlayers = [...gameData.players];
                        let updatedDeck = [...gameData.deck];
                        
                        aiSelectedPlayers.forEach(playerId => {
                            const playerIndex = updatedPlayers.findIndex(p => p.id === playerId);
                            if(playerIndex !== -1 && updatedDeck.length > 0) {
                                const newCard = updatedDeck.shift();
                                updatedPlayers[playerIndex].cards.push(newCard);
                                console.log(`${updatedPlayers[playerIndex].nickname}에게 카드 지급:`, newCard.emoji + newCard.number);
                            }
                        });
                        
                        // 다음 왕으로 턴 넘기기
                        const nextKingIndex = (gameData.currentKingIndex + 1) % gameData.players.length;
                        let nextRound = gameData.currentRound;
                        
                        if(nextKingIndex === 0) {
                            nextRound++;
                        }
                        
                        // 새 미션 설정
                        const newMission = missions[Math.floor(Math.random() * missions.length)];
                        
                        // Firestore 업데이트
                        await db.collection('games').doc(currentRoomCode).update({
                            players: updatedPlayers,
                            deck: updatedDeck,
                            currentKingIndex: nextKingIndex,
                            currentRound: nextRound,
                            currentMission: newMission,
                            selectedPlayers: []
                        });
                        
                        document.getElementById('aiThinking').classList.add('hidden');
                        
                    } catch (error) {
                        console.error('AI 턴 처리 오류:', error);
                        document.getElementById('aiThinking').classList.add('hidden');
                    }
                }, 3000);
            }

            // AI 카드 플레이 (왕 턴이 아닐 때)
            async function handleAICardPlay() {
                // 현재 왕이 아닌 AI들의 카드 플레이 처리
                const currentKing = gameData.players[gameData.currentKingIndex];
                
                for(let i = 0; i < gameData.players.length; i++) {
                    const player = gameData.players[i];
                    
                    // 현재 왕이거나 AI가 아니면 패스
                    if(!player.isAI || player.id === currentKing.id) continue;
                    
                    // 카드가 6장 이상이거나 좋은 조합이 있으면 행동
                    if(player.cards.length <= 5 && !hasGoodCombination(player.cards)) continue;
                    
                    console.log(`AI ${player.nickname} 카드 플레이 시작`);
                    
                    await new Promise(resolve => {
                        setTimeout(async () => {
                            try {
                                await performAICardAction(player, i);
                                resolve();
                            } catch(error) {
                                console.error('AI 카드 액션 오류:', error);
                                resolve();
                            }
                        }, 3000); // 3초 대기
                    });
                }
            }
            
            // AI 카드 액션 수행
            async function performAICardAction(player, playerIndex) {
                const aiCards = player.cards;
                let bestCombination = null;
                let bestScore = 0;
                
                // 2~5장 조합 중 최고 점수 찾기
                for (let size = 2; size <= Math.min(5, aiCards.length); size++) {
                    const combinations = getCombinations(aiCards, size);
                    for (let combo of combinations) {
                        const result = calculateCombinationScore(combo);
                        if (result.score > bestScore) {
                            bestScore = result.score;
                            bestCombination = combo;
                        }
                    }
                }
                
                const updatedPlayers = [...gameData.players];
                let updatedDeck = [...gameData.deck];
                
                // AI 의사결정: 조합 점수가 5점 이상이거나 카드가 6장 이상이면 행동
                const shouldPlayCombo = bestScore >= 5 || (aiCards.length >= 6 && bestScore > 0);
                
                if (shouldPlayCombo && bestCombination) {
                    console.log(`AI ${player.nickname} 조합 사용: ${bestScore}점`);
                    // 조합 사용
                    updatedPlayers[playerIndex].score = (updatedPlayers[playerIndex].score || 0) + bestScore;
                    updatedPlayers[playerIndex].cards = updatedPlayers[playerIndex].cards.filter(
                        card => !bestCombination.some(c => c.id === card.id)
                    );
                    updatedDeck.push(...bestCombination);
                } else if (aiCards.length > 5) {
                    console.log(`AI ${player.nickname} 카드 버리기`);
                    // 가장 낮은 점수 카드 버리기 (조커 제외)
                    const normalCards = aiCards.filter(c => !c.isJoker);
                    const cardToDiscard = normalCards.length > 0 ? 
                        normalCards.sort((a, b) => a.number - b.number)[0] : 
                        aiCards[0];
                        
                    const cardIndex = updatedPlayers[playerIndex].cards.findIndex(c => c.id === cardToDiscard.id);
                    updatedPlayers[playerIndex].cards.splice(cardIndex, 1);
                    updatedDeck.push(cardToDiscard);
                }
                
                // Firestore 업데이트
                await db.collection('games').doc(currentRoomCode).update({
                    players: updatedPlayers,
                    deck: updatedDeck
                });
            }

        // AI가 좋은 조합을 가지고 있는지 확인
        function hasGoodCombination(cards) {
            for (let size = 2; size <= Math.min(5, cards.length); size++) {
                const combinations = getCombinations(cards, size);
                for (let combo of combinations) {
                    const score = calculateCombinationScore(combo).score;
                    if (score >= 5) { // 5점 이상이면 좋은 조합으로 판단
                        return true;
                    }
                }
            }
            return false;
        }

        // 조합 생성 헬퍼 함수
        function getCombinations(arr, size) {
            if (size === 1) return arr.map(item => [item]);
            return arr.flatMap((item, index) =>
                getCombinations(arr.slice(index + 1), size - 1).map(combo => [item, ...combo])
            );
        }

        // 미션 팝업 표시
        function showMissionPopup() {
            document.getElementById('missionText').textContent = gameData.currentMission;
            document.getElementById('missionPopup').classList.remove('hidden');
        }

        // 미션 팝업 닫기
        function closeMissionPopup() {
            document.getElementById('missionPopup').classList.add('hidden');
        }

        // 화면 표시 헬퍼 함수들
        function hideAllScreens() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.add('hidden');
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
        }

        function showError(message) {
            hideAllScreens();
            document.getElementById('errorScreen').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // 페이지 언로드 시 리스너 정리
        window.addEventListener('beforeunload', function() {
            if(gameListener) {
                gameListener();
            }
        });
    </script>
</body>
</html>
